const { Asset } = require("parcel-bundler");
const localRequire = require("parcel-bundler/lib/utils/localRequire");

class TypeScriptAsset extends Asset {
  constructor(name, options) {
    super(name, options);
    this.type = "js";
  }

  // Async pretransform() {
  //   let esbuild = await localRequire("esbuild", this.name);
  //   this.service = await esbuild.startService();
  // }

  // async postProcess() {
  //   this.service.stop();
  // }

  async generate() {
    // Require esbuild, installed locally in the app
    let esbuild = await localRequire("esbuild", this.name);
    this.service = await esbuild.startService();
    let transpilerOptions = {
      compilerOptions: {
        module: this.options.scopeHoist ? "exnext" : "commonjs",
        jsx: "preserve",

        // It brings the generated output from TypeScript closer to that generated by Babel
        // see https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-7.html
        esModuleInterop: true
      },
      fileName: this.relativeName
    };

    let tsconfig = await this.getConfig(["tsconfig.json"]);

    // Overwrite default if config is found
    if (tsconfig) {
      let { compilerOptions, ...rest } = tsconfig;
      transpilerOptions.compilerOptions = Object.assign(
        transpilerOptions.compilerOptions,
        compilerOptions
      );
      Object.assign(transpilerOptions, rest);
    }

    transpilerOptions.compilerOptions.noEmit = false;
    transpilerOptions.compilerOptions.sourceMap = this.options.sourceMaps;
    // Transpile Module using TypeScript and parse result as ast format through babylon
    const loader = this.relativeName.substring(
      this.relativeName.lastIndexOf(".") + 1
    );
    let transpiled = await this.service.transform(this.contents, {
      tsconfigRaw: JSON.stringify(transpilerOptions),
      sourcemap: transpilerOptions.compilerOptions.sourceMap,
      sourcefile: this.relativeName,
      format: 'cjs',
      loader
    });
    console.log(loader);

    this.service.stop();

    let sourceMap = transpiled.map;

    if (sourceMap) {
      sourceMap = JSON.parse(sourceMap);
      sourceMap.sources = [this.relativeName];
      sourceMap.sourcesContent = [this.contents];

      // // Remove the source map URL
      let content = transpiled.code;
      transpiled.code = content.substring(
        0,
        content.lastIndexOf("//# sourceMappingURL")
      );
    }

    return [
      {
        type: "js",
        value: transpiled.code,
        sourceMap
      }
    ];
  }
}

module.exports = TypeScriptAsset;
